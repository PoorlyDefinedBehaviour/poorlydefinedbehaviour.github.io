<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Generating tests from a TLA+ specification |</title><meta name=keywords content><meta name=description content="Formal methods
Formal methods are techniques – usually based on mathematics – used for the specification, analysis and verification of software and hardware.
Why would anyone be interested in formal methods?
The main reasons to consider formal methods are verifying that a design is correct, verifying that a change is correct, analysing a system to learn about it and developing an intuition about the system.




Formal methods is the umbrella term that contains several techniques inside of it

We&rsquo;ll be considering only model checking because I believe it is the easiest to get started with and get a return on the investment quickly."><meta name=author content="poorlydefinedbehaviour"><link rel=canonical href=https://poorlydefinedbehaviour.github.io/posts/tla_test_generation_1/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://poorlydefinedbehaviour.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://poorlydefinedbehaviour.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://poorlydefinedbehaviour.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://poorlydefinedbehaviour.github.io/apple-touch-icon.png><link rel=mask-icon href=https://poorlydefinedbehaviour.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://poorlydefinedbehaviour.github.io/posts/tla_test_generation_1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://poorlydefinedbehaviour.github.io/posts/tla_test_generation_1/"><meta property="og:title" content="Generating tests from a TLA+ specification"><meta property="og:description" content="Formal methods Formal methods are techniques – usually based on mathematics – used for the specification, analysis and verification of software and hardware.
Why would anyone be interested in formal methods? The main reasons to consider formal methods are verifying that a design is correct, verifying that a change is correct, analysing a system to learn about it and developing an intuition about the system.
Formal methods is the umbrella term that contains several techniques inside of it We’ll be considering only model checking because I believe it is the easiest to get started with and get a return on the investment quickly."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-20T00:00:00+00:00"><meta property="article:modified_time" content="2025-07-20T00:00:00+00:00"><meta property="og:image" content="https://poorlydefinedbehaviour.github.io/papermod-cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://poorlydefinedbehaviour.github.io/papermod-cover.png"><meta name=twitter:title content="Generating tests from a TLA+ specification"><meta name=twitter:description content="Formal methods
Formal methods are techniques – usually based on mathematics – used for the specification, analysis and verification of software and hardware.
Why would anyone be interested in formal methods?
The main reasons to consider formal methods are verifying that a design is correct, verifying that a change is correct, analysing a system to learn about it and developing an intuition about the system.




Formal methods is the umbrella term that contains several techniques inside of it

We&rsquo;ll be considering only model checking because I believe it is the easiest to get started with and get a return on the investment quickly."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://poorlydefinedbehaviour.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Generating tests from a TLA+ specification","item":"https://poorlydefinedbehaviour.github.io/posts/tla_test_generation_1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Generating tests from a TLA+ specification","name":"Generating tests from a TLA\u002b specification","description":"Formal methods Formal methods are techniques – usually based on mathematics – used for the specification, analysis and verification of software and hardware.\nWhy would anyone be interested in formal methods? The main reasons to consider formal methods are verifying that a design is correct, verifying that a change is correct, analysing a system to learn about it and developing an intuition about the system.\nFormal methods is the umbrella term that contains several techniques inside of it We\u0026rsquo;ll be considering only model checking because I believe it is the easiest to get started with and get a return on the investment quickly.\n","keywords":[],"articleBody":"Formal methods Formal methods are techniques – usually based on mathematics – used for the specification, analysis and verification of software and hardware.\nWhy would anyone be interested in formal methods? The main reasons to consider formal methods are verifying that a design is correct, verifying that a change is correct, analysing a system to learn about it and developing an intuition about the system.\nFormal methods is the umbrella term that contains several techniques inside of it We’ll be considering only model checking because I believe it is the easiest to get started with and get a return on the investment quickly.\nFormal methods for design A design doc is meant to be a recipe for a piece of software, it usually contains a problem overview, one or more possible solutions for the problem and a description of how each solution would be implemented.\nThe description of the solutions in the design doc always contains several assumptions about how its dependencies and how the implementation will work. These assumptions may be correct, partially correct or incorrect.\nA design doc author could enumerate all assumptions and requirements the solution aims to solve manually in a matrix – and some people actually do – but that’s clearly too much effort for most projects.\nFormal methods can be included in the phase where the design doc is created. Instead of only describing the solution using words, build a specification of the solution and how it interacts with other parts of the system using a specification language. The specification is then checked against the invariants you define by a model checker, the model checker outputs a sequence of steps that lead to an invariant being violated known as a counter example. The counter example is used for debugging and reproducing the issue.\nA snippet of a sequence of states leading to a bug being found TLA+ TLA+ is a formal specification language that can be used in the design process of a new system, to find flaws in existing systems, to build a better understanding of existing systems and to prove correctness of algorithms.\nTLA+ is a simple language that consists mostly of variables and actions that assign values to variables.\nCheck the cheatsheet.\nHere’s an example specification of a clock that starts between 1 and 2, goes up to 12 then goes back to 1. There’s one invariant checking that at all times the clock hours are between 1 and 12 and a temporal property saying that the clock must reach midnight (12) eventually.\nA TLA+ spec modelling a clock that starts between 1 and 2, counts up to 12 then goes back to 1 [] Is read as always\n\u003c\u003e is read as eventually\nFormal methods for analysing a system When a system already exists, it can be valuable to write a specification based on the existing system to gain a deeper understanding of how the system works. Everything must be explicit in a TLA+ specification, it’s common to start writing a specification and realize that you don’t actually understand how something works when you actually need to define its behavior. Sometimes new bugs may even be found in the already existing system after writing a specification.\nFormal methods for testing a system A model checked TLA+ specification will visit every possible behavior in the system, model checking is exhaustive up to a max number of inputs that the specification author defines. After writing a specification, it’s possible to use the specification in combination with the model checker to generate test cases for the real implementation.\nMongoDB has a blog post where they talk about generating test cases for a real system using one of their TLA+ specs. They got 100% test coverage by doing that compared to 21% from manually written tests and 91% from AFL.\nThe paper Model-guided Fuzzing of Distributed Systems talks about using a TLA+ specification state space to guide a fuzzer to test the real implementation of the specifications. The authors found bugs in etcd-raft and RedisRaft by using this technique.\nExperimenting with formal methods Since most of the team was not familiar with TLA+, we decided to focus the efforts on a small subset of new a new project and to put some effort into knowledge sharing to make it easier for people in the team to get comfortable with the tool.\nThe chosen project provides a secret store type of interface where services can store secrets such as passwords and retrieve them when needed. Operations such as creating and deleting secrets were async at first and the service responsible for managing secrets – known as the secrets service – was using the outbox pattern to maintain consistency.\nWe started exploring TLA+ while working on the outbox so we decided to model the outbox interactions to make sure our design was sound. We did not model only the basic operations such as adding an operation to the queue but also the invariants that must always be true for the system to behave correctly.\nOne of the invariants is that there may be only one operation in progress at a time per secret. This invariant was modelled in our specification as follows:\nSecretMetadataHasPendingStatusWhenTheresAnOperationInTheQueue == \\* For all secrets \\A secret \\in Secrets: LET SecretIsInPendingQueue == \\E i \\in DOMAIN queue.pending: queue.pending[i] = secret IN \\* the secret is either in the outbox queue \\/ /\\ SecretIsInPendingQueue \\* and the secret metadata status is Pending /\\ SecretMetadataHasPendingStatus(secret) \\* or the secret is not in the queue \\/ /\\ ~SecretIsInPendingQueue \\* and the secret metadata status is not Pending /\\ ~SecretMetadataHasPendingStatus(secret) An invariant that says: For every existing secret, either there's an operation for it in the outbox queue and the secret status is Pending or there's no operation for the secret in the queue and the secret status is not Pending An invariant that says that something bad never happens is known as a safety property. TLA+ also allows us to specify properties that say that something good eventually happens, known as liveness properties.\nOur specification defines that when an operation for a secret is added to the outbox queue, the operation will eventually succeed and the secret status will be set to Succeeded.\nEventuallyEveryMetadataStatusIsReady == \\* For all secrets \\A secret \\in Secrets: \\* Transform the queue.pending tuple into a set LET PendingQueueSet == {queue.pending[i]: i \\in DOMAIN queue.pending} IN \\* If the secret is in the pending queue /\\ secret \\in PendingQueueSet \\* Leads to it eventually ~\u003e \\* Being in the processed queue /\\ secret \\in queue.processed \\* And removed from the pending queue /\\ secret \\notin PendingQueueSet \\* And the secret being in the metadata table with status \"Succeeded\" /\\ \\E metadata \\in db.secret_metadata: /\\ metadata.name = secret /\\ metadata.status = \"Succeeded\" A temporal property that says: when an operation for a secret is in the outbox queue, eventually the operation will be processed (retried if needed) and the secret will be moved to the Succeeded status We didn’t get to use the specification to generate tests yet but we were already able to reap one of the benefits of formal modelling: a deeper understanding of the system being specified. While writing the specification, we were forced to answer several questions since we needed to make the behavior explicit.\nCatching logic bugs with formal methods Some months ago, a team hit a bug where two regions sharing the same SQL database but with caches that were unique per instance would lead to valid tokens being cached as invalid. A cache invalidation bug.\nAfter the bug was found, a basic specification that models the behavior of the systems with the shared database was written in a few minutes. The spec is high-level, doesn’t contain implementation details at all and found the same bug immediately.\nA counter example produced by the model checker. The counter example is a list of steps that lead to the invariant being violated We are also exploring deterministic simulation testing as a lightweight formal method but we haven’t got far enough with it yet.\nHands-on prerequisites: Install TLA+ tools Download the TLA+ toolbox from the official website\nOpen VSCode and install the TLA+ extension\nCreate a file called spec.tla. This is where you’ll write your spec.\nWrite the following boilerplate in your spec.tla file:\n---- MODULE spec ---- EXTENDS TLC, Integers, FiniteSets, Naturals \\* Write your spec here ==== Hands-on: Clock Given the following boilerplate, write a specification for a clock that counts from 0 to 12 and then resets back to 0.\n---- MODULE spec ---- EXTENDS TLC, Integers, FiniteSets, Naturals \\* Write your spec here ==== Hands-on: Waves Given a group of people forming a circle\nAfter choosing one person in the circle at random, the person must high five the person to its left, then duck and then high five the person to its right. A person that’s ducking cannot get up or high five someone until another high five has happened. High fives happen in counterclockwise direction starting from the person that was chosen in the beginning. The wave ends when the person that started the process is reached again.\nOne of the people in the circle is chosen at random The person high fives the person to their left The person ducks after high fiving the person to their left The next person in the circle in counterclockwise direction repeats the process Hands-on: Die hard The die hard problem is a problem from the movie Die hard with a vengeance. There is a 5 liters water jug, a 3 liters water jug, a very precise scale (that doesn’t show the weight of items on top of it), and a faucet with an infinite stream of water. There’s a bomb ready to explode in a few seconds and the only way to stop it is to put exactly 4 liters of water on the scale.\nSource: WikiHow The jugs start empty. The possible actions are:\nFill one of the jugs with water – remember that the jugs are unmarked so the only way to know how much water is in one of them is filling them until they’re completely full.\nRemove water from one of the jugs\nMove water from one jug to the other, remember that each jug has a limited capacity.\nDesign a specification to find the shortest sequence of steps to solve the die hard problem. The solution is found when one of the jugs has exactly 4 liters of water in it.\nHands-on: Two phase commit Two phase commit is a distributed commit protocol where all participants in a transaction should eventually commit or rollback.\nTwo phase commit is a protocol that can be found in many real worlds systems, some of them being:\nMySQL: Transactions in MySQL clusters\nPostgres: Meant to be used by external transaction managers\nThe protocol works in the following manner: one node is a designated coordinator, which is the master site, and the rest of the nodes in the network are designated the participants. The protocol assumes that:\nthere is stable storage at each node with a write-ahead log,\nno node crashes forever,\nthe data in the write-ahead log is never lost or corrupted in a crash, and\nany two nodes can communicate with each other.\nA complete execution of the two phase commit protocol. Source: Wikipedia Choose between specifying the two phase commit protocol or creating your own protocol for distributed transactions. Imagine that there’s a single transaction and it must commit or abort on all nodes. Remember that nodes may crash at any time.\nHands-on: Single decree paxos Paxos is a protocol heavily used in the industry to implement replicated systems when the systems need to decide on a value and the value that’s decided must be the same for all the nodes involved.\nPaxos is used in many real world systems, some of them being:\nCassandra: For lightweight distributed transactions\nGoogle Spanner: For state machine replication\nFailure model:\nProcesses crash at any time\nMessages can be lost\nMessages can be reordered\nA brief summary of the single decree paxos protocol Invent and specify a protocol to make 3 nodes decide on the same value. The value must be proposed by one of the nodes and the other nodes cannot know which value will be proposed ahead of time.\nDoes my implementation match the specification? You just wrote a specification that models your system at an abstraction level that doesn’t care about things such as I/O. The specification is a high level version of the implementation that captures the main properties of the system you’re trying to build.\nNext == \\/ \\E instance \\in Instances, namespace \\in Namespaces, value \\in Values, data_key_id \\in DataKeyIds: Encrypt(instance, namespace, value, data_key_id) \\/ \\E instance \\in Instances, namespace \\in Namespaces, data_key_id \\in DataKeyIds: Decrypt(instance, namespace, data_key_id) \\/ \\E instance \\in Instances, namespace \\in Namespaces: RotateDataKeys(instance, namespace) \\/ \\E instance \\in Instances: \\/ CacheRemoveExpiredEntries(instance) \\/ RestartInstance(instance) \\/ AdvanceTime \\/ Terminating The next state relation. Defines which actions can be taken at each step in the model checking process The model checker uses the specification to check possibly thousands of behaviors, generating a graph of the reachable states. A state is the set of variables with their values.\nA graph generated by model checking the a specification of a module that uses the outbox pattern The number of times each action was executed during the model checking of a specification Every invariant is satisfied by the behaviors allowed by the specification and you believe your spec gives you enough confidence to move on to the implementation.\nDataKeyUidUniqueness == \\A dk1 \\in database: {dk2 \\in database : dk2.uid = dk1.uid} = {dk1} DataKeyUniqueness == \\A dk1, dk2 \\in database: (/\\ dk1.uid /= dk2.uid /\\ dk1.namespace = dk2.namespace) /\\ dk1.label = dk2.label /\\ dk1.active /\\ dk2.active =\u003e Assert(FALSE, \u003c\u003c\"duplicated data key\", dk1, dk2\u003e\u003e) CacheConsistency == \\A instance \\in Instances: /\\ \\A entry \\in instances[instance].cache.by_id: \\E row \\in database: /\\ entry.namespace = row.namespace /\\ entry.data_key.uid = row.uid /\\ \\A entry \\in instances[instance].cache.by_label: \\E row \\in database: /\\ entry.namespace = row.namespace /\\ entry.data_key.uid = row.uid DataKeysAreCachedByLabelOnlyAfterCautionPeriod == \\A instance \\in Instances: \\A entry \\in instances[instance].cache.by_label: Assert((now - entry.data_key.created) \u003e CautionPeriod, \u003c\u003c\"data key cached before caution period\", \"now\", now, \"entry.data_key.created\", entry.created, \"CautionPeriod\", CautionPeriod\u003e\u003e) A few examples of invariants defined in a specification The implementation is coming along just fine but you can’t help but think how do you know that the implementation implements what’s in the specification. If the implementation follows the specification precisely, the implementation will be a refinement of the specification – it will allow every behavior allowed by the specification and possibly more behaviors.\nfunc (s *EncryptionManager) RotateDataKeys(ctx context.Context, namespace string) error { s.log.Info(\"Data keys rotation triggered, acquiring lock...\") s.mtx.Lock() defer s.mtx.Unlock() s.log.Info(\"Data keys rotation started\") err := s.store.DisableDataKeys(ctx, namespace) if err != nil { s.log.Error(\"Data keys rotation failed\", \"error\", err) return err } s.dataKeyCache.flush(namespace) s.log.Info(\"Data keys rotation finished successfully\") return nil } A snippet of the implementation of the system that was modelled in the specification Maybe at this point you decide to put the implementation and the specification side by side and pattern match between them.\nRotateDataKeys(instance, namespace) == /\\ DisableDataKeys(namespace) /\\ DataKeyCacheFlush(instance, namespace) /\\ UNCHANGED now A snippet of one of the actions defined in the specification That can get you quite far but having the implementation execute the same sequence of actions that the specification allows would increase the confidence that the implementation actually implements the specification.\nThe output graph generated in the model checking process can be used to build every possible path from the initial state to the final state. Similar to what has been done here, the paths can be used to exercise the implementation in a normal test.\nA diagram generated in the model checking process. The diagram contains every possible state and how to get there The generated graph is stored in a .dot file, the test starts by reading and parsing the graph stored in the file.\nfunc TestParseDotFile(t *testing.T) { file, err := os.Open(\"./testdata/spec2.dot\") require.NoError(t, err) defer file.Close() buffer, err := io.ReadAll(file) require.NoError(t, err) graphAst, _ := gographviz.ParseString(string(buffer)) graph := gographviz.NewGraph() if err := gographviz.Analyse(graphAst, graph); err != nil { panic(err) } } A snippet of a test that reads and parses a file containing the graph of reachable states generated by model checking a specification Then for each possible path starting from the initial state, we apply each action in the order they appear in the path. Here’s a few examples of the possible sequence of actions:\n[Init AdvanceTime AdvanceTime RestartInstance] [Init Encrypt AdvanceTime AdvanceTime RestartInstance] [Init Encrypt AdvanceTime AdvanceTime CacheRemoveExpiredEntries] [Init Encrypt AdvanceTime AdvanceTime RotateDataKeys] [Init Encrypt AdvanceTime AdvanceTime Decrypt] [Init AdvanceTime AdvanceTime CacheRemoveExpiredEntries] [Init AdvanceTime AdvanceTime RotateDataKeys] [Init AdvanceTime AdvanceTime Encrypt] Examples of sequences of actions that will be used to exercise the implementation Each sequence is a test case to which the implementation is exercised against.\nfor path := range visitor.Iter() { check(t, path) } For each action in the path generated based on the specification, an action that’s equivalent to it is applied to the implementation. It boils down to a loop and a switch case.\nfunc check(t *testing.T, path []visitor.EdgeWithLabel) { defer func() { if t.Failed() { pathJSONbytes, _ := json.MarshalIndent(path, \"\", \" \") fmt.Printf(\"%s\\n\\n\", string(pathJSONbytes)) } }() var ( encryptionManager *EncryptionManager encryptedValuesByKeyId map[string][]map[string][]byte fakeTime *fakeTime ) for _, node := range path { switch node.Label { case \"Init\": // Initialize the system under test ... case \"Encrypt\": // Perform the Encrypt operation ... case \"Decrypt\": // Perform the Decrypt operation ... case \"RotateDataKeys\": // Perform the RotateDataKeys operation ... case \"AdvanceTime\": // Perform the AdvanceTime operation ... case \"CacheRemoveExpiredEntries\": // Perform the CacheRemoveExpiredEntries operation ... case \"RestartInstance\": // Perform the RestartInstance operation ... default: panic(fmt.Sprintf(\"unhandled label, did you forget a switch case?: %+v\", node)) } } } Assertions are added at any place you seem fit. It’s recommended to assert that the system is in a valid state and that every response received – if any – makes sense at each step.\nGenerating tests for snapshot isolation implementation In databases, snapshot isolation is a transaction isolation level that guarantees that a transaction will have the illusion of working on a snapshot of the database, the snapshot is taken at the time the transaction starts.\nSpecifications for snapshot isolation can be easily found but I’ve decided to write my own in TLA+. After writing the specification I decided to implement an example database with snapshot isolation in Go. After I was done with the implementation and had written a few tests I decided to generate the test cases using the state graph generated during the model checking process.\nfor path := range visitor.Iter() { db := NewDatabase() // Map from model tx id to impl tx modelMap := make(map[int]int) for _, node := range path { switch node.Label { case \"TxRead\": modelTxId := int(mustParseInt(node.Args[0])) key := node.Args[1] db.Read(modelMap[modelTxId], key) case \"TxBegin\": modelTxId := int(mustParseInt(node.Args[0])) txId := db.BeginTransaction() modelMap[modelTxId] = txId case \"TxCreate\": modelTxId := int(mustParseInt(node.Args[0])) key := node.Args[1] value := node.Args[2] db.Write(modelMap[modelTxId], key, value) case \"TxUpdate\": modelTxId := int(mustParseInt(node.Args[0])) key := node.Args[1] value := node.Args[2] db.Write(modelMap[modelTxId], key, value) case \"TxDelete\": modelTxId := int(mustParseInt(node.Args[0])) key := node.Args[1] db.Delete(modelMap[modelTxId], key) case \"TxRollback\": require.Equal(t, 1, len(node.Args)) modelTxId := int(mustParseInt(node.Args[0])) db.Rollback(modelMap[modelTxId]) case \"TxCommit\": require.Equal(t, 1, len(node.Args)) modelTxId := int(mustParseInt(node.Args[0])) db.Commit(modelMap[modelTxId]) case \"Terminating\": // no-op default: panic(fmt.Sprintf(\"unhandled action: %+v\", node)) } } } A snippet of the code used to test the database with snapshot isolation with the paths generated from the model checking the specification. Some code has been removed to make the snippet shorter The generated test cases resulted in 100% code coverage without any special effort.\nAn image showing a code coverage report with 100% coverage. Green means the code has been exercised during testing I also got a specification for snapshot isolation from github.com/will62794/snapshot-isolation-spec. It was the first one I found and I decided to generate test cases from it as well. The following is the first result I got after running the tests.\nAn image showing a code coverage report with 78% coverage. Green means the code has been exercised during testing After that I decided to exercise the snapshot isolation implementation from the blog post Implementing MVCC and major SQL transaction isolation levels. I got 85.8% coverage using the specification I wrote. Note that Phil’s implementation contains more than just the code for the snapshot isolation level so code paths related to other isolation levels are not covered – as expected.\nAn image showing a code coverage report with 85.8% coverage. Green means the code has been exercised during testing I also ran the same tests but using will62794’s specification this time and got 80.1% coverage in the first try.\nAn image showing a code coverage report with 80.1% coverage. Green means the code has been exercised during testing Generating tests for the encryption manager The encryption manager is a package used for envelope encryption. A specification modeling some of the operations supposed by the encryption manager was used to generate test cases for the implementation. The test cases resulted in 60.3% coverage.\nNext == \\/ \\E instance \\in Instances, namespace \\in Namespaces, value \\in Values, data_key_id \\in DataKeyIds: Encrypt(instance, namespace, value, data_key_id) \\/ \\E instance \\in Instances, namespace \\in Namespaces, data_key_id \\in DataKeyIds: Decrypt(instance, namespace, data_key_id) \\/ \\E instance \\in Instances, namespace \\in Namespaces: RotateDataKeys(instance, namespace) \\/ \\E instance \\in Instances: \\/ CacheRemoveExpiredEntries(instance) \\/ RestartInstance(instance) \\/ Terminating The next state relation of the encryption manager specification Most of the uncovered lines are error handling paths or unsupported operations. Both cases were not modeled in the specification.\nAn image showing a code coverage report with 60.3% coverage. Green means the code has been exercised during testing ","wordCount":"3621","inLanguage":"en","image":"https://poorlydefinedbehaviour.github.io/papermod-cover.png","datePublished":"2025-07-20T00:00:00Z","dateModified":"2025-07-20T00:00:00Z","author":{"@type":"Person","name":"poorlydefinedbehaviour"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://poorlydefinedbehaviour.github.io/posts/tla_test_generation_1/"},"publisher":{"@type":"Organization","name":"","logo":{"@type":"ImageObject","url":"https://poorlydefinedbehaviour.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://poorlydefinedbehaviour.github.io/ title=Home><span>Home</span></a></li><li><a href=https://poorlydefinedbehaviour.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://poorlydefinedbehaviour.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://poorlydefinedbehaviour.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://poorlydefinedbehaviour.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://poorlydefinedbehaviour.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Generating tests from a TLA+ specification</h1><div class=post-meta><span title='2025-07-20 00:00:00 +0000 UTC'>July 20, 2025</span>&nbsp;·&nbsp;17 min&nbsp;·&nbsp;poorlydefinedbehaviour&nbsp;|&nbsp;<a href=https://github.com/PoorlyDefinedBehaviour/poorlydefinedbehaviour.github.io/tree/main/content/posts/tla_test_generation_1/index.md rel="noopener noreferrer edit" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#formal-methods aria-label="Formal methods">Formal methods</a></li><li><a href=#why-would-anyone-be-interested-in-formal-methods aria-label="Why would anyone be interested in formal methods?">Why would anyone be interested in formal methods?</a></li><li><a href=#formal-methods-for-design aria-label="Formal methods for design">Formal methods for design</a></li><li><a href=#tla aria-label=TLA+>TLA+</a></li><li><a href=#formal-methods-for-analysing-a-system aria-label="Formal methods for analysing a system">Formal methods for analysing a system</a></li><li><a href=#formal-methods-for-testing-a-system aria-label="Formal methods for testing a system">Formal methods for testing a system</a></li><li><a href=#experimenting-with-formal-methods aria-label="Experimenting with formal methods">Experimenting with formal methods</a></li><li><a href=#catching-logic-bugs-with-formal-methods aria-label="Catching logic bugs with formal methods">Catching logic bugs with formal methods</a></li><li><a href=#hands-on-prerequisites-install-tla-tools aria-label="Hands-on prerequisites: Install TLA+ tools">Hands-on prerequisites: Install TLA+ tools</a></li><li><a href=#hands-on-clock aria-label="Hands-on: Clock">Hands-on: Clock</a></li><li><a href=#hands-on-waves aria-label="Hands-on: Waves">Hands-on: Waves</a></li><li><a href=#hands-on-die-hard aria-label="Hands-on: Die hard">Hands-on: Die hard</a></li><li><a href=#hands-on-two-phase-commit aria-label="Hands-on: Two phase commit">Hands-on: Two phase commit</a></li><li><a href=#hands-on-single-decree-paxos aria-label="Hands-on: Single decree paxos">Hands-on: Single decree paxos</a></li><li><a href=#does-my-implementation-match-the-specification aria-label="Does my implementation match the specification?">Does my implementation match the specification?</a></li><li><a href=#generating-tests-for-snapshot-isolation-implementation aria-label="Generating tests for snapshot isolation implementation">Generating tests for snapshot isolation implementation</a></li><li><a href=#generating-tests-for-the-encryption-manager aria-label="Generating tests for the encryption manager">Generating tests for the encryption manager</a></li></ul></div></details></div><div class=post-content><h2 id=formal-methods>Formal methods<a hidden class=anchor aria-hidden=true href=#formal-methods>#</a></h2><p>Formal methods are techniques – usually based on mathematics – used for the specification, analysis and verification of software and hardware.</p><h2 id=why-would-anyone-be-interested-in-formal-methods>Why would anyone be interested in formal methods?<a hidden class=anchor aria-hidden=true href=#why-would-anyone-be-interested-in-formal-methods>#</a></h2><p>The main reasons to consider formal methods are verifying that a design is correct, verifying that a change is correct, analysing a system to learn about it and developing an intuition about the system.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXeItStmwei-06gHeLcBczgo2RjIandofBbnfTbpzcvatoJg0EwARIEXpCLo5hGK0bDcYvoggtmOmhsA-HXdCW858FWr7Ry6gUxnP4o0NN8AkXNeDpy7gpSLSC5z5mXyktIDxl1HSg?key=CZuYqiYDpsuzokR8yCzjpg"></div><div style=font-style:italic;text-align:center;font-size:90%>Formal methods is the umbrella term that contains several techniques inside of it</div><p>We&rsquo;ll be considering only model checking because I believe it is the easiest to get started with and get a return on the investment quickly.</p><h2 id=formal-methods-for-design>Formal methods for design<a hidden class=anchor aria-hidden=true href=#formal-methods-for-design>#</a></h2><p>A design doc is meant to be a recipe for a piece of software, it usually contains a problem overview, one or more possible solutions for the problem and a description of how each solution would be implemented.</p><p>The description of the solutions in the design doc always contains several assumptions about how its dependencies and how the implementation will work. These assumptions may be correct, partially correct or incorrect.</p><p>A design doc author could enumerate all assumptions and requirements the solution aims to solve manually in a matrix – and some people actually do – but that&rsquo;s clearly too much effort for most projects.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXctXqlBFwrpTOCBcRBVluZwmFv_DVcTnPaQa9VCsR6TBoCpelWrgr76flhLhaabJyTalMCBiRO4RxborjeTsyueLiunK8CfuBnUu7h5tHYSHdy8atC_oaquIPeTGjhiyPfrCw-VVQ?key=CZuYqiYDpsuzokR8yCzjpg"></div><p>Formal methods can be included in the phase where the design doc is created. Instead of only describing the solution using words, build a specification of the solution and how it interacts with other parts of the system using a <a href=https://en.wikipedia.org/wiki/Specification_language>specification language</a>. The specification is then checked against the invariants you define by a model checker, the model checker outputs a sequence of steps that lead to an invariant being violated known as a counter example. The counter example is used for debugging and reproducing the issue.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXfgD4kUdKnf3cRMGHAwsRUfEhwGSXn5SnIwtynkELQ7YHDPxcvZvc5Pvhoj9M8H7yzLDIwX6S8sJADtBTeamNkOy6tUmD9F166S8Tct1BLAL9pD9viFs1dAU14T3nFiyugTzERfqg?key=CZuYqiYDpsuzokR8yCzjpg"></div><div style=font-style:italic;text-align:center;font-size:90%>A snippet of a sequence of states leading to a bug being found</div><h2 id=tla>TLA+<a hidden class=anchor aria-hidden=true href=#tla>#</a></h2><p><a href=https://github.com/tlaplus/tlaplus>TLA+</a> is a formal specification language that can be used in the design process of a new system, to find flaws in existing systems, to build a better understanding of existing systems and to prove correctness of algorithms.</p><p>TLA+ is a simple language that consists mostly of variables and actions that assign values to variables.</p><p>Check the <a href=https://ocamlpro.com/assets/pdf/tla-cheat-sheet-v1.pdf>cheatsheet</a>.</p><p>Here&rsquo;s an example specification of a clock that starts between 1 and 2, goes up to 12 then goes back to 1. There&rsquo;s one invariant checking that at all times the clock hours are between 1 and 12 and a temporal property saying that the clock must reach midnight (12) eventually.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXcaPNHdwqn9eeSxyfRFJLXSugxRWEdhO9sP43brXI4V5Nfdxbki2ZcE4EA_lRqmPoJPBKSqK_q6recJlI26h1Ie5RO5n-314l0zyK0kYQmrigALK3sg9F8FReC4WSj-GgH7SLUR?key=CZuYqiYDpsuzokR8yCzjpg"></div><div style=font-style:italic;text-align:center;font-size:90%>A TLA+ spec modelling a clock that starts between 1 and 2, counts up to 12 then goes back to 1</div><p><strong>[]</strong> Is read as always</p><p><strong>&lt;></strong> is read as eventually</p><h2 id=formal-methods-for-analysing-a-system>Formal methods for analysing a system<a hidden class=anchor aria-hidden=true href=#formal-methods-for-analysing-a-system>#</a></h2><p>When a system already exists, it can be valuable to write a specification based on the existing system to gain a deeper understanding of how the system works. Everything must be explicit in a TLA+ specification, it&rsquo;s common to start writing a specification and realize that you don&rsquo;t actually understand how something works when you actually need to define its behavior. Sometimes new bugs may even be found in the already existing system after writing a specification.</p><h2 id=formal-methods-for-testing-a-system>Formal methods for testing a system<a hidden class=anchor aria-hidden=true href=#formal-methods-for-testing-a-system>#</a></h2><p>A model checked TLA+ specification will visit every possible behavior in the system, model checking is exhaustive up to a max number of inputs that the specification author defines. After writing a specification, it&rsquo;s possible to use the specification in combination with the model checker to generate test cases for the real implementation.</p><p>MongoDB has a blog <a href=https://www.mongodb.com/company/blog/engineering/conformance-checking-at-mongodb-testing-our-code-matches-our-tla-specs>post</a> where they talk about generating test cases for a real system using one of their TLA+ specs. They got 100% test coverage by doing that compared to 21% from manually written tests and 91% from <a href=https://github.com/google/AFL>AFL</a>.</p><p>The paper <a href=https://arxiv.org/pdf/2410.02307>Model-guided Fuzzing of Distributed Systems</a> talks about using a TLA+ specification state space to guide a fuzzer to test the real implementation of the specifications. The authors found bugs in etcd-raft and RedisRaft by using this technique.</p><h2 id=experimenting-with-formal-methods>Experimenting with formal methods<a hidden class=anchor aria-hidden=true href=#experimenting-with-formal-methods>#</a></h2><p>Since most of the team was not familiar with TLA+, we decided to focus the efforts on a small subset of new a new project and to put some effort into knowledge sharing to make it easier for people in the team to get comfortable with the tool.</p><p>The chosen project provides a secret store type of interface where services can store secrets such as passwords and retrieve them when needed. Operations such as creating and deleting secrets were async at first and the service responsible for managing secrets – known as the secrets service – was using the <a href=https://microservices.io/patterns/data/transactional-outbox.html>outbox pattern</a> to maintain consistency.</p><p>We started exploring TLA+ while working on the outbox so we decided to model the outbox interactions to make sure our design was sound. We did not model only the basic operations such as adding an operation to the queue but also the invariants that must always be true for the system to behave correctly.</p><p>One of the invariants is that there may be only one operation in progress at a time per secret. This invariant was modelled in our specification as follows:</p><pre tabindex=0><code>SecretMetadataHasPendingStatusWhenTheresAnOperationInTheQueue ==
      \* For all secrets
      \A secret \in Secrets:
        LET SecretIsInPendingQueue == 
            \E i \in DOMAIN queue.pending:
                queue.pending[i] = secret
        IN
        \* the secret is either in the outbox queue
        \/ /\ SecretIsInPendingQueue
           \* and the secret metadata status is Pending
           /\ SecretMetadataHasPendingStatus(secret)
        \* or the secret is not in the queue
        \/ /\ ~SecretIsInPendingQueue
           \* and the secret metadata status is not Pending
           /\ ~SecretMetadataHasPendingStatus(secret)
</code></pre><div style=font-style:italic;text-align:center;font-size:90%>An invariant that says: For every existing secret, either there's an operation for it in the outbox queue and the secret status is Pending or there's no operation for the secret in the queue and the secret status is not Pending</div><p>An invariant that says that something <strong>bad</strong> never happens is known as a <em>safety</em> property. TLA+ also allows us to specify properties that say that something <strong>good <em>eventually happens</em></strong>, known as <em>liveness</em> properties.</p><p>Our specification defines that when an operation for a secret is added to the outbox queue, the operation will eventually succeed and the secret status will be set to <strong>Succeeded.</strong></p><pre tabindex=0><code>EventuallyEveryMetadataStatusIsReady ==
    \* For all secrets
    \A secret \in Secrets:
        \* Transform the queue.pending tuple into a set
        LET PendingQueueSet == {queue.pending[i]: i \in DOMAIN queue.pending} IN
            \* If the secret is in the pending queue
            /\ secret \in PendingQueueSet
            \* Leads to it eventually
            ~&gt;
                \* Being in the processed queue
                /\ secret \in queue.processed
                \* And removed from the pending queue
                /\ secret \notin PendingQueueSet
                \* And the secret being in the metadata table with status &#34;Succeeded&#34;
                /\ \E metadata \in db.secret_metadata:
                    /\ metadata.name = secret
                    /\ metadata.status = &#34;Succeeded&#34;
</code></pre><div style=font-style:italic;text-align:center;font-size:90%>A temporal property that says: when an operation for a secret is in the outbox queue, eventually the operation will be processed (retried if needed) and the secret will be moved to the Succeeded status</div><p>We didn&rsquo;t get to use the specification to generate tests yet but we were already able to reap one of the benefits of formal modelling: a deeper understanding of the system being specified. While writing the specification, we were forced to answer several questions since we needed to make the behavior explicit.</p><h2 id=catching-logic-bugs-with-formal-methods>Catching logic bugs with formal methods<a hidden class=anchor aria-hidden=true href=#catching-logic-bugs-with-formal-methods>#</a></h2><p>Some months ago, a team hit a bug where two regions sharing the same SQL database but with caches that were unique per instance would lead to valid tokens being cached as invalid. A cache invalidation bug.</p><p>After the bug was found, a basic specification that models the behavior of the systems with the shared database was written in a few minutes. The spec is high-level, doesn&rsquo;t contain implementation details at all and found the same bug immediately.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXeJ3m9tmhogFXjCyGTOfo7BRwXJcMd_XDXMZ7giGIb3AaQRNmhHiRh76Wuo-zKTZ5dkHpaRlPSQWSGeNJqnCUp814RuOzhH6n7X5EK_Lez0-7172ONzf0oTuVl4XWBF37ZX-GwCMw?key=CZuYqiYDpsuzokR8yCzjpg"></div><div style=font-style:italic;text-align:center;font-size:90%>A counter example produced by the model checker. The counter example is a list of steps that lead to the invariant being violated</div><p>We are also exploring <a href=https://poorlydefinedbehavior.github.io/posts/deterministic_simulation_testing/>deterministic simulation testing</a> as a <a href=https://dl.acm.org/doi/pdf/10.1145/3477132.3483540>lightweight formal method</a> but we haven&rsquo;t got far enough with it yet.</p><h2 id=hands-on-prerequisites-install-tla-tools>Hands-on prerequisites: Install TLA+ tools<a hidden class=anchor aria-hidden=true href=#hands-on-prerequisites-install-tla-tools>#</a></h2><ul><li><p>Download the TLA+ toolbox from the official <a href=https://lamport.azurewebsites.net/tla/toolbox.html>website</a></p></li><li><p>Open VSCode and install the TLA+ extension</p></li></ul><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXfAFLtt-YdcocuzT1en_PV0z2QwGd-cOxgVS0LO8bze7TVEJnFehI0AbK6_d3hx71E9OdaBk_RJXah8d-BD6jaJuaB6ZrxT1rPixONj_9gC4HRka8U9j49MJB8CTWvS7_c58YrJ0Q?key=CZuYqiYDpsuzokR8yCzjpg"></div><ul><li><p>Create a file called <strong><em>spec.tla</em></strong>. This is where you&rsquo;ll write your spec.</p></li><li><p>Write the following boilerplate in your <strong><em>spec.tla</em></strong> file:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>----</span> <span style=color:#a6e22e>MODULE</span> <span style=color:#a6e22e>spec</span> <span style=color:#f92672>----</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>EXTENDS</span> <span style=color:#a6e22e>TLC</span>, <span style=color:#a6e22e>Integers</span>, <span style=color:#a6e22e>FiniteSets</span>, <span style=color:#a6e22e>Naturals</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> <span style=color:#a6e22e>Write</span> <span style=color:#a6e22e>your</span> <span style=color:#a6e22e>spec</span> <span style=color:#a6e22e>here</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>====</span>
</span></span></code></pre></div><h2 id=hands-on-clock>Hands-on: Clock<a hidden class=anchor aria-hidden=true href=#hands-on-clock>#</a></h2><p>Given the following boilerplate, write a specification for a clock that counts from 0 to 12 and then resets back to 0.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>----</span> <span style=color:#a6e22e>MODULE</span> <span style=color:#a6e22e>spec</span> <span style=color:#f92672>----</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>EXTENDS</span> <span style=color:#a6e22e>TLC</span>, <span style=color:#a6e22e>Integers</span>, <span style=color:#a6e22e>FiniteSets</span>, <span style=color:#a6e22e>Naturals</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>\</span><span style=color:#f92672>*</span> <span style=color:#a6e22e>Write</span> <span style=color:#a6e22e>your</span> <span style=color:#a6e22e>spec</span> <span style=color:#a6e22e>here</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>====</span>
</span></span></code></pre></div><h2 id=hands-on-waves>Hands-on: Waves<a hidden class=anchor aria-hidden=true href=#hands-on-waves>#</a></h2><p>Given a group of people forming a circle</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXeCF2dOHv3MAIK0wxT2SMf5LsDFGFpHI4Y5FxRF5V6sjCVdpPf-FR_ZSevkMi5vBf53MAUbc4hxc2Khz18P560BoUCfK4Jjl5UhpAXsrzAmy2-kTqOCWhUqbsUVK-Bk_Aq3_r_A9Q?key=CZuYqiYDpsuzokR8yCzjpg"></div><p>After choosing one person in the circle at random, the person must high five the person to its left, then duck and then high five the person to its right. A person that&rsquo;s ducking cannot get up or high five someone until another high five has happened. High fives happen in counterclockwise direction starting from the person that was chosen in the beginning. The wave ends when the person that started the process is reached again.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXd58ia-whZxyjz6qGHYeR-oVlVY9QvGwU3Ebez2VtDpeScdihlZaiVj24Mjl4DYO8apP6xssPCH8fMhmVfYp3AjVBsJKXpG_TL0H4cr-1Mam0R0gMvPC6-tWY1rA3W5tSOm_geYdg?key=CZuYqiYDpsuzokR8yCzjpg"></div><div style=font-style:italic;text-align:center;font-size:90%>One of the people in the circle is chosen at random</div><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXcN5uSwI5buxEjxchg72VE6el9okhJTexvRPQDzHVMH0pgE3VQ3xMvWdlm3jz-B8XFwBflTajn5VWI9wwT9TRwgo_SeXTB6xSzicTHsztBe3u8-PYt8QVTaxZdzNPSxLc63w6ZHfg?key=CZuYqiYDpsuzokR8yCzjpg"></div><div style=font-style:italic;text-align:center;font-size:90%>The person high fives the person to their left</div><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXds3R2PPHvp7e2P8RCoN5lwniDt9BR9wNKsYrcGMa2imQpwxOBff70yPVOmRBsuqvQd4vqHCeUucEDMvYQD55zoghbWbv81CR6aVVfDdypUefrzDG-h2GBsjP45c8eOpUuoP0Cl?key=CZuYqiYDpsuzokR8yCzjpg"></div><div style=font-style:italic;text-align:center;font-size:90%>The person ducks after high fiving the person to their left</div><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXda3dXEFL2S8QnDZAtsI5u6-xDz2adYFa1suKYmOF2AVLt22KmpRl9yymAXWjjZbR-IoaC-6nSmUE7fxMZTWEyf4rxV5DwgR5MhPT--vS0FcOzN3phwz4B9GT1OmnBYj87eOcJXhg?key=CZuYqiYDpsuzokR8yCzjpg"></div><div style=font-style:italic;text-align:center;font-size:90%>The next person in the circle in counterclockwise direction repeats the process</div><h2 id=hands-on-die-hard>Hands-on: Die hard<a hidden class=anchor aria-hidden=true href=#hands-on-die-hard>#</a></h2><p>The die hard problem is a problem from the movie <a href=https://www.imdb.com/title/tt0112864/>Die hard with a vengeance</a>. There is a 5 liters water jug, a 3 liters water jug, a very precise scale (that doesn&rsquo;t show the weight of items on top of it), and a faucet with an infinite stream of water. There&rsquo;s a bomb ready to explode in a few seconds and the only way to stop it is to put exactly 4 liters of water on the scale.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXcnEshTTwEwf26K2Ozzaebe9kaFOrFL_zZ7F2f57yPfJkxsX9voX_R8gM3JuJM7Xu81S9K2a85CM2OnDBN2tP-TUR1NHReqwHul77ykDcsuQFqOYSgiOaiXX1pPpVdTDtzMM4DpyA?key=CZuYqiYDpsuzokR8yCzjpg"></div><div style=font-style:italic;text-align:center;font-size:90%>Source: WikiHow</div><p>The jugs start empty. The possible actions are:</p><ul><li><p>Fill one of the jugs with water – remember that the jugs are unmarked so the only way to know how much water is in one of them is filling them until they&rsquo;re completely full.</p></li><li><p>Remove water from one of the jugs</p></li><li><p>Move water from one jug to the other, remember that each jug has a limited capacity.</p></li></ul><p>Design a specification to find the shortest sequence of steps to solve the die hard problem. The solution is found when one of the jugs has exactly 4 liters of water in it.</p><h2 id=hands-on-two-phase-commit>Hands-on: Two phase commit<a hidden class=anchor aria-hidden=true href=#hands-on-two-phase-commit>#</a></h2><p><a href=https://en.wikipedia.org/wiki/Two-phase_commit_protocol>Two phase commit</a> is a distributed commit protocol where all participants in a transaction should eventually commit or rollback.</p><p>Two phase commit is a protocol that can be found in many real worlds systems, some of them being:</p><p>MySQL: Transactions in MySQL clusters</p><p>Postgres: Meant to be used by external transaction managers</p><p>The protocol works in the following manner: one node is a designated coordinator, which is the master site, and the rest of the nodes in the network are designated the participants. The protocol assumes that:</p><ol><li><p>there is stable storage at each node with a write-ahead log,</p></li><li><p>no node crashes forever,</p></li><li><p>the data in the write-ahead log is never lost or corrupted in a crash, and</p></li><li><p>any two nodes can communicate with each other.</p></li></ol><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXemlWnZY1sUnpWBldf3LoiAwAYsWFyKpVG4Hg-oXDHJ8B9OI0WpIlydqxm7BybmwYroBrneIEpE7agGQkBU7E5AerOH87FjoPw4raVv7eeDKW-f9i-21Tz_5i-Sw8EuLA7ttskt?key=CZuYqiYDpsuzokR8yCzjpg"></div><div style=font-style:italic;text-align:center;font-size:90%>A complete execution of the two phase commit protocol. Source: Wikipedia</div><p>Choose between specifying the two phase commit protocol or creating your own protocol for distributed transactions. Imagine that there&rsquo;s a single transaction and it must commit or abort on all nodes. Remember that nodes may crash at any time.</p><h2 id=hands-on-single-decree-paxos>Hands-on: Single decree paxos<a hidden class=anchor aria-hidden=true href=#hands-on-single-decree-paxos>#</a></h2><p><a href=https://lamport.azurewebsites.net/pubs/paxos-simple.pdf>Paxos</a> is a protocol heavily used in the industry to implement replicated systems when the systems need to decide on a value and the value that&rsquo;s decided must be the same for all the nodes involved.</p><p>Paxos is used in many real world systems, some of them being:</p><p>Cassandra: <a href=https://www.datastax.com/blog/lightweight-transactions-cassandra-20>For lightweight distributed transactions</a></p><p>Google Spanner: <a href=https://static.googleusercontent.com/media/research.google.com/en//archive/spanner-osdi2012.pdf>For state machine replication</a></p><p>Failure model:</p><ul><li><p>Processes crash at any time</p></li><li><p>Messages can be lost</p></li><li><p>Messages can be reordered</p></li></ul><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXeRo6VT0bK8hbIawlZhs2RfgK8oGVU0TrzSAQiYqaAU0QFMwFIY6j1FMG-TkfT5N2fyIKFnfretooFD4Zfi9eV0e_i7f1YHaWHwwtuyHJYiGHeDqcxgV2vkMXL-fOzrjsxNzvH1?key=CZuYqiYDpsuzokR8yCzjpg"></div><div style=font-style:italic;text-align:center;font-size:90%>A brief summary of the single decree paxos protocol</div><p>Invent and specify a protocol to make 3 nodes decide on the same value. The value must be proposed by one of the nodes and the other nodes cannot know which value will be proposed ahead of time.</p><h2 id=does-my-implementation-match-the-specification>Does my implementation match the specification?<a hidden class=anchor aria-hidden=true href=#does-my-implementation-match-the-specification>#</a></h2><p>You just wrote a specification that models your system at an abstraction level that doesn&rsquo;t care about things such as I/O. The specification is a high level version of the implementation that captures the main properties of the system you&rsquo;re trying to build.</p><pre tabindex=0><code>Next ==
  \/  \E instance \in Instances, namespace \in Namespaces, value \in Values, data_key_id \in DataKeyIds:
               Encrypt(instance, namespace, value, data_key_id)
  \/  \E instance \in Instances, namespace \in Namespaces, data_key_id \in DataKeyIds:
               Decrypt(instance, namespace, data_key_id)
  \/  \E instance \in Instances, namespace \in Namespaces:
               RotateDataKeys(instance, namespace)
  \/  \E instance \in Instances:
               \/  CacheRemoveExpiredEntries(instance)
               \/  RestartInstance(instance)
  \/  AdvanceTime
  \/  Terminating
</code></pre><div style=font-style:italic;text-align:center;font-size:90%>The next state relation. Defines which actions can be taken at each step in the model checking process</div><p>The model checker uses the specification to check possibly thousands of behaviors, generating a graph of the reachable states. A state is the set of variables with their values.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXciCPmiGSuIAmcOJC-YVUkgaoEeFAVHZsjleA-OZDZM-Uyd5CBqlFFWIILRuJXQd0quX2Mprsl4rlLQV_Huf0yaJhm__7oZMh_HKfNJRY_ACIecb3NTBzJxITYbc3C7OIyqx28J2Q?key=2053luUD1bm7MwEnF9Bh-w"></div><div style=font-style:italic;text-align:center;font-size:90%>A graph generated by model checking the a specification of a module that uses the outbox pattern</div><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXclXIeQzzb98-Sv03tljxXTJDf7fGrZdMiMO_WeyDMljkRO_eU2S4MiEpHgzbjv1Sd2frEIfUk5RPBuvIe5Xa0Vvaa6o-R5dOQt6TB6lcuFZhO9qAcD0SlBYIs8W6yvAhhruwOSnw?key=2053luUD1bm7MwEnF9Bh-w"></div><div style=font-style:italic;text-align:center;font-size:90%>The number of times each action was executed during the model checking of a specification</div><p>Every invariant is satisfied by the behaviors allowed by the specification and you believe your spec gives you <strong><em>enough</em></strong> confidence to move on to the implementation.</p><pre tabindex=0><code>DataKeyUidUniqueness ==
   \A dk1 \in database:
       {dk2 \in database : dk2.uid = dk1.uid} = {dk1}

DataKeyUniqueness ==
   \A dk1, dk2 \in database:
       (/\ dk1.uid /= dk2.uid
        /\ dk1.namespace = dk2.namespace)
        /\ dk1.label = dk2.label
        /\ dk1.active
        /\ dk2.active
           =&gt;
               Assert(FALSE, &lt;&lt;&#34;duplicated data key&#34;, dk1, dk2&gt;&gt;)

CacheConsistency ==
   \A instance \in Instances:
       /\  \A entry \in instances[instance].cache.by_id:
               \E row \in database:
                   /\ entry.namespace = row.namespace
                   /\ entry.data_key.uid = row.uid
       /\  \A entry \in instances[instance].cache.by_label:
               \E row \in database:
                   /\ entry.namespace = row.namespace
                   /\ entry.data_key.uid = row.uid

DataKeysAreCachedByLabelOnlyAfterCautionPeriod ==
   \A instance \in Instances:
       \A entry \in instances[instance].cache.by_label:
           Assert((now - entry.data_key.created) &gt; CautionPeriod,
                 &lt;&lt;&#34;data key cached before caution period&#34;,
                  &#34;now&#34;, now,
                  &#34;entry.data_key.created&#34;, entry.created,
                  &#34;CautionPeriod&#34;, CautionPeriod&gt;&gt;)
</code></pre><div style=font-style:italic;text-align:center;font-size:90%>A few examples of invariants defined in a specification</div><p>The implementation is coming along just fine but you can&rsquo;t help but think how do you know that the implementation implements what&rsquo;s in the specification. If the implementation follows the specification precisely, the implementation will be a refinement of the specification – it will allow every behavior allowed by the specification and possibly more behaviors.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EncryptionManager</span>) <span style=color:#a6e22e>RotateDataKeys</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>namespace</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Data keys rotation triggered, acquiring lock...&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mtx</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>mtx</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Data keys rotation started&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>DisableDataKeys</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>namespace</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;Data keys rotation failed&#34;</span>, <span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>dataKeyCache</span>.<span style=color:#a6e22e>flush</span>(<span style=color:#a6e22e>namespace</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Info</span>(<span style=color:#e6db74>&#34;Data keys rotation finished successfully&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div style=font-style:italic;text-align:center;font-size:90%>A snippet of the implementation of the system that was modelled in the specification</div><p>Maybe at this point you decide to put the implementation and the specification side by side and pattern match between them.</p><pre tabindex=0><code>RotateDataKeys(instance, namespace) ==
    /\  DisableDataKeys(namespace)
    /\  DataKeyCacheFlush(instance, namespace)
    /\  UNCHANGED now
</code></pre><div style=font-style:italic;text-align:center;font-size:90%>A snippet of one of the actions defined in the specification</div><p>That can get you quite far but having the implementation execute the same sequence of actions that the specification allows would increase the confidence that the implementation actually implements the specification.</p><p>The output graph generated in the model checking process can be used to build every possible path from the initial state to the final state. Similar to what has been done here, the paths can be used to exercise the implementation in a normal test.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXcvNCOUD-wUJISaRpa8Vz7hxsNr_TKzm8WCaGvjMVgFrQP9PbTwfsRS-YFO8EOwK4gGI7eZesvX5e4NveuCnc2FNHbE98qk3bDtKBO4xtjCjUuP5OCpNufLqpD-X87hE5Er3tqZ?key=2053luUD1bm7MwEnF9Bh-w"></div><div style=font-style:italic;text-align:center;font-size:90%>A diagram generated in the model checking process. The diagram contains every possible state and how to get there</div><p>The generated graph is stored in a <em>.dot</em> file, the test starts by reading and parsing the graph stored in the file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestParseDotFile</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;./testdata/spec2.dot&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>file</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>buffer</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>file</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>NoError</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>graphAst</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gographviz</span>.<span style=color:#a6e22e>ParseString</span>(string(<span style=color:#a6e22e>buffer</span>))
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>graph</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gographviz</span>.<span style=color:#a6e22e>NewGraph</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gographviz</span>.<span style=color:#a6e22e>Analyse</span>(<span style=color:#a6e22e>graphAst</span>, <span style=color:#a6e22e>graph</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div style=font-style:italic;text-align:center;font-size:90%>A snippet of a test that reads and parses a file containing the graph of reachable states generated by model checking a specification</div><p>Then for each possible path starting from the initial state, we apply each action in the order they appear in the path. Here&rsquo;s a few examples of the possible sequence of actions:</p><pre><code>[Init AdvanceTime AdvanceTime RestartInstance]
[Init Encrypt AdvanceTime AdvanceTime RestartInstance]
[Init Encrypt AdvanceTime AdvanceTime CacheRemoveExpiredEntries]
[Init Encrypt AdvanceTime AdvanceTime RotateDataKeys]
[Init Encrypt AdvanceTime AdvanceTime Decrypt]
[Init AdvanceTime AdvanceTime CacheRemoveExpiredEntries]
[Init AdvanceTime AdvanceTime RotateDataKeys]
[Init AdvanceTime AdvanceTime Encrypt]
</code></pre><div style=font-style:italic;text-align:center;font-size:90%>Examples of sequences of actions that will be used to exercise the implementation</div><p>Each sequence is a test case to which the implementation is exercised against.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>visitor</span>.<span style=color:#a6e22e>Iter</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>check</span>(<span style=color:#a6e22e>t</span>, <span style=color:#a6e22e>path</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For each action in the path generated based on the specification, an action that&rsquo;s equivalent to it is applied to the implementation. It boils down to a loop and a switch case.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>check</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>, <span style=color:#a6e22e>path</span> []<span style=color:#a6e22e>visitor</span>.<span style=color:#a6e22e>EdgeWithLabel</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Failed</span>() {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>pathJSONbytes</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalIndent</span>(<span style=color:#a6e22e>path</span>, <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;  &#34;</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%s\n\n&#34;</span>, string(<span style=color:#a6e22e>pathJSONbytes</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>encryptionManager</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>EncryptionManager</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>encryptedValuesByKeyId</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fakeTime</span>               <span style=color:#f92672>*</span><span style=color:#a6e22e>fakeTime</span>
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>path</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Label</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;Init&#34;</span>:
</span></span><span style=display:flex><span>     <span style=color:#75715e>// Initialize the system under test</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;Encrypt&#34;</span>:
</span></span><span style=display:flex><span>     <span style=color:#75715e>// Perform the Encrypt operation</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;Decrypt&#34;</span>:
</span></span><span style=display:flex><span>     <span style=color:#75715e>// Perform the Decrypt operation</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;RotateDataKeys&#34;</span>:
</span></span><span style=display:flex><span>     <span style=color:#75715e>// Perform the RotateDataKeys operation</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;AdvanceTime&#34;</span>:
</span></span><span style=display:flex><span>     <span style=color:#75715e>// Perform the AdvanceTime operation</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;CacheRemoveExpiredEntries&#34;</span>:
</span></span><span style=display:flex><span>     <span style=color:#75715e>// Perform the CacheRemoveExpiredEntries operation</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;RestartInstance&#34;</span>:
</span></span><span style=display:flex><span>     <span style=color:#75715e>// Perform the RestartInstance operation</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>      panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;unhandled label, did you forget a switch case?: %+v&#34;</span>, <span style=color:#a6e22e>node</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Assertions are added at any place you seem fit. It&rsquo;s recommended to assert that the system is in a valid state and that every response received – if any – makes sense at each step.</p><h2 id=generating-tests-for-snapshot-isolation-implementation>Generating tests for snapshot isolation implementation<a hidden class=anchor aria-hidden=true href=#generating-tests-for-snapshot-isolation-implementation>#</a></h2><p>In databases, snapshot isolation is a transaction isolation level that guarantees that a transaction will have the illusion of working on a snapshot of the database, the snapshot is taken at the time the transaction starts.</p><p>Specifications for snapshot isolation can be easily found but I&rsquo;ve decided to write my own in TLA+. After writing the specification I decided to implement an example database with snapshot isolation in Go. After I was done with the implementation and had written a few tests I decided to generate the test cases using the state graph generated during the model checking process.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>visitor</span>.<span style=color:#a6e22e>Iter</span>() {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>db</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewDatabase</span>()
</span></span><span style=display:flex><span>   <span style=color:#75715e>// Map from model tx id to impl tx</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>modelMap</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int</span>]<span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>path</span> {
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Label</span> {
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;TxRead&#34;</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>modelTxId</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>mustParseInt</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>modelMap</span>[<span style=color:#a6e22e>modelTxId</span>], <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;TxBegin&#34;</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>modelTxId</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>mustParseInt</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>txId</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>BeginTransaction</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>modelMap</span>[<span style=color:#a6e22e>modelTxId</span>] = <span style=color:#a6e22e>txId</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;TxCreate&#34;</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>modelTxId</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>mustParseInt</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>modelMap</span>[<span style=color:#a6e22e>modelTxId</span>], <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;TxUpdate&#34;</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>modelTxId</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>mustParseInt</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>modelMap</span>[<span style=color:#a6e22e>modelTxId</span>], <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;TxDelete&#34;</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>modelTxId</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>mustParseInt</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>modelMap</span>[<span style=color:#a6e22e>modelTxId</span>], <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;TxRollback&#34;</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#ae81ff>1</span>, len(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>modelTxId</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>mustParseInt</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Rollback</span>(<span style=color:#a6e22e>modelMap</span>[<span style=color:#a6e22e>modelTxId</span>])
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;TxCommit&#34;</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>t</span>, <span style=color:#ae81ff>1</span>, len(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>modelTxId</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>mustParseInt</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Commit</span>(<span style=color:#a6e22e>modelMap</span>[<span style=color:#a6e22e>modelTxId</span>])
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;Terminating&#34;</span>:
</span></span><span style=display:flex><span>       <span style=color:#75715e>// no-op</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>       panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;unhandled action: %+v&#34;</span>, <span style=color:#a6e22e>node</span>))
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><div style=font-style:italic;text-align:center;font-size:90%>A snippet of the code used to test the database with snapshot isolation with the paths generated from the model checking the specification. Some code has been removed to make the snippet shorter</div><p>The generated test cases resulted in 100% code coverage without any special effort.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXcNlUuBudJsjL451VG1S7rIT5-k_Nw2V1IbuiU6XrNem55GwjWQAHtUtSN-tdIe8sJAs2TDQNU6HSAz1kuIWpmmoKVTgnOeep6ud8s24ZYiRMHdFpu5GK_Qhyu-PbpqFULPUHKNnQ?key=2053luUD1bm7MwEnF9Bh-w"></div><div style=font-style:italic;text-align:center;font-size:90%>An image showing a code coverage report with 100% coverage. Green means the code has been exercised during testing</div><p>I also got a specification for snapshot isolation from <a href=http://github.com/will62794/snapshot-isolation-spec>github.com/will62794/snapshot-isolation-spec</a>. It was the first one I found and I decided to generate test cases from it as well. The following is the first result I got after running the tests.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXcSJN66BMnpXmFfc8uxDFz7N30usVNRRQTpf8XISBd11Izl0NVYD9HIvmg8V0CkgIVoG06sRb1sViekaS0Z2Oy_lY1Gu68zhfFitUuy8F5TaObSSYqtBoe8-wJXjHeq4aDLm0Fc?key=2053luUD1bm7MwEnF9Bh-w"></div><div style=font-style:italic;text-align:center;font-size:90%>An image showing a code coverage report with 78% coverage. Green means the code has been exercised during testing</div><p>After that I decided to exercise the snapshot isolation implementation from the blog post <a href=https://notes.eatonphil.com/2024-05-16-mvcc.html>Implementing MVCC and major SQL transaction isolation levels</a>. I got 85.8% coverage using the specification I wrote. Note that Phil&rsquo;s implementation contains more than just the code for the snapshot isolation level so code paths related to other isolation levels are not covered – as expected.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXe3H79Zc8NIfD2oVm80O9NHUhAgO8X-YeA1wsS0TU9u2k4YJxWhvBzEnhhZEiU-Nk6EU9_rJ-HtvVrAUdbGIs5AhUlbPFYzbPK8mPeoCHE9lGNHTIpaF_NqioCZgeh9SmvYHO5U?key=2053luUD1bm7MwEnF9Bh-w"></div><div style=font-style:italic;text-align:center;font-size:90%>An image showing a code coverage report with 85.8% coverage. Green means the code has been exercised during testing</div><p>I also ran the same tests but using will62794&rsquo;s specification this time and got 80.1% coverage in the first try.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXddrKebU47GS14iw7F9IlhiBPxZ2CioerYIh1N5zHsli7YuYS-mmdCCpbeIMsRvc2viH76KvceVrkCCCtKns9dRjpS8bPGyF7TYfbIbEuvFG0PR83ukAe1hj3_R7t9yP7SV-trRuw?key=2053luUD1bm7MwEnF9Bh-w"></div><div style=font-style:italic;text-align:center;font-size:90%>An image showing a code coverage report with 80.1% coverage. Green means the code has been exercised during testing</div><h2 id=generating-tests-for-the-encryption-manager>Generating tests for the encryption manager<a hidden class=anchor aria-hidden=true href=#generating-tests-for-the-encryption-manager>#</a></h2><p>The encryption manager is a package used for envelope encryption. A specification modeling some of the operations supposed by the encryption manager was used to generate test cases for the implementation. The test cases resulted in 60.3% coverage.</p><pre tabindex=0><code>Next ==
   \/  \E instance \in Instances, namespace \in Namespaces, value \in Values, data_key_id \in DataKeyIds:
           Encrypt(instance, namespace, value, data_key_id)
   \/  \E instance \in Instances, namespace \in Namespaces, data_key_id \in DataKeyIds:
           Decrypt(instance, namespace, data_key_id)
   \/  \E instance \in Instances, namespace \in Namespaces:
           RotateDataKeys(instance, namespace)
   \/  \E instance \in Instances:
           \/  CacheRemoveExpiredEntries(instance)
           \/  RestartInstance(instance)
   \/  Terminating
</code></pre><div style=font-style:italic;text-align:center;font-size:90%>The next state relation of the encryption manager specification</div><p>Most of the uncovered lines are error handling paths or unsupported operations. Both cases were not modeled in the specification.</p><div align=center><img style=width:50% src="https://lh7-rt.googleusercontent.com/docsz/AD_4nXfk0U7dE9-pHpbhbZ1mA9fSD1RJxvefadquvQX0xFBmmQWb_23NBvyUtsUEGlhXpzeA8TOTVjswqN_REVx86-xoa991-8xYFv5hT6C_KJPNXsbOSZyiPrrdsDvbnNUMyu8X3raIaA?key=2053luUD1bm7MwEnF9Bh-w"></div><div style=font-style:italic;text-align:center;font-size:90%>An image showing a code coverage report with 60.3% coverage. Green means the code has been exercised during testing</div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://poorlydefinedbehaviour.github.io/posts/reading_list_2024/><span class=title>Next »</span><br><span>Reading list 2024</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Generating tests from a TLA+ specification on x" href="https://x.com/intent/tweet/?text=Generating%20tests%20from%20a%20TLA%2b%20specification&amp;url=https%3a%2f%2fpoorlydefinedbehaviour.github.io%2fposts%2ftla_test_generation_1%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Generating tests from a TLA+ specification on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fpoorlydefinedbehaviour.github.io%2fposts%2ftla_test_generation_1%2f&amp;title=Generating%20tests%20from%20a%20TLA%2b%20specification&amp;summary=Generating%20tests%20from%20a%20TLA%2b%20specification&amp;source=https%3a%2f%2fpoorlydefinedbehaviour.github.io%2fposts%2ftla_test_generation_1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Generating tests from a TLA+ specification on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fpoorlydefinedbehaviour.github.io%2fposts%2ftla_test_generation_1%2f&title=Generating%20tests%20from%20a%20TLA%2b%20specification"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Generating tests from a TLA+ specification on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fpoorlydefinedbehaviour.github.io%2fposts%2ftla_test_generation_1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Generating tests from a TLA+ specification on whatsapp" href="https://api.whatsapp.com/send?text=Generating%20tests%20from%20a%20TLA%2b%20specification%20-%20https%3a%2f%2fpoorlydefinedbehaviour.github.io%2fposts%2ftla_test_generation_1%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Generating tests from a TLA+ specification on telegram" href="https://telegram.me/share/url?text=Generating%20tests%20from%20a%20TLA%2b%20specification&amp;url=https%3a%2f%2fpoorlydefinedbehaviour.github.io%2fposts%2ftla_test_generation_1%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Generating tests from a TLA+ specification on ycombinator" href="https://news.ycombinator.com/submitlink?t=Generating%20tests%20from%20a%20TLA%2b%20specification&u=https%3a%2f%2fpoorlydefinedbehaviour.github.io%2fposts%2ftla_test_generation_1%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://poorlydefinedbehaviour.github.io/></a></span>·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>